@page "/"
@using SolanaPaper.Data.Models
@using SolanaPaper.Data.Models.SolanaPaper.Data.Models
@using SolanaPaper.Data.Repositories
@using SolanaPaper.Services
@using SolanaPaper.Services.Solana
@using SolanaPaper.Data.Models.ModelBuilders;
@using System.Collections.ObjectModel
@using TradingView.Blazor;
@using TradingView.Blazor.Models
@using System.Net;
@using System.Text;

<PageTitle>Index</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

<SurveyPrompt Title="How is Blazor working for you?" />

<TradingViewChart @ref=myChart />



@code
{
    [Inject]
    OhlcvRepository ohlcvRepository { get; set; }

    BitQueryService bitQueryService = new BitQueryService();

    TradingViewChart? myChart;

    ObservableCollection<Ohlcv> ohlcvs;
    List<Ohlcv> ohlcvEntries = new List<Ohlcv>();

    // List<PricePoint> ohlcvs = new List<PricePoint>();


    string mintAddress = "4er1XqvoyL6tLesUpbMTXDJkqhrZxmBSwCetWSWspump";
    string programID = "6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P";
    string interval = "minutes";
    string count = "1";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        if (firstRender)
        {
            try
            {
                ChartService chartDataHelper = new ChartService(ohlcvRepository, bitQueryService);

                // query from mongo before bitquery
                await chartDataHelper.GetMongoOhlcv(ohlcvEntries, mintAddress);


                if (!ohlcvEntries.Any())
                {
                    await chartDataHelper.GetBitQueryOhlcv(ohlcvEntries, mintAddress, programID, interval, count);
                }
                else 
                {
                    await chartDataHelper.GetBitQueryOhlcv(ohlcvEntries, ohlcvEntries.Last().Time, mintAddress, programID, interval, count);
                }

                // ohlcvs = new ObservableCollection<Ohlcv>(chartDataHelper.OrderByTime(ohlcvEntries));

                ohlcvs = new ObservableCollection<Ohlcv>(chartDataHelper.OrderByTime(ohlcvEntries));

                // ohlcvs.Add(ohlcvEntries.First());
                ChartData data = new()
                    {
                        ChartEntries = new List<IChartEntry>(ohlcvs),
                        MarkerData = new List<Marker>()
                    };

                ChartOptions options = new()
                    {
                        TimeScaleSecondsVisible = true,
                        Width = 800, // Fixed width for debugging
                        Height = 400 // Add a fixed height
                    };
                   
                ///TODO : TRY TO LOAD THE GRPAH ITERATIVELY MAYBE IT WILL GO SECOND BY SECOND.

                if (myChart != null)
                {
                    Console.WriteLine("Loading chart...");
                    await myChart.LoadChartAsync(data, options);
                    Console.WriteLine("Chart loaded successfully.");
                }

                ohlcvs.CollectionChanged += OnOhcvCollectionChanged;

                // foreach (Ohlcv ohlcv in ohlcvEntries)
                // {
                //     ohlcvs.Add(ohlcv);
                // }

                try 
                {
                    await bitQueryService.StreamTokenPrice(ohlcvs, mintAddress, programID);

                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error: {ex.Message}");
                }

            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading chart: {ex.Message}");
            }
        }
    }

    public async void OnOhcvCollectionChanged(object sender, EventArgs e)
    {
        Console.WriteLine("OHLCV collection changed!");
        await UpdateChartAsync();
    }

    public async Task UpdateChartAsync()
    {
        if (myChart != null)
        {
            ChartData updatedChartData = new()
                {
                    ChartEntries = new List<IChartEntry>(ohlcvs),
                    MarkerData = new List<Marker>()
                };
            await myChart.UpdateChartAsync(updatedChartData);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // ohlcvEntries = new List<Ohlcv>();
    }
}